\section{研究背景与意义}
随着移动互联网和物联网的蓬勃发展, 智能移动终端设备迅速普及\juhao 
截止2018年9月,国内智能手机用户数量已达到7.8亿\upcite{smartphone2018statistics}, 占总人口数的55\%以上\juhao 如此众多的用户极大地促进了移动应用的发展, 2018年的数据显示\upcite{appAmount2018}, 谷歌公司的Google Play上已经有超260万应用软件, 苹果公司的App Store上也有超过200万应用软件可供下载使用\juhao 这些应用软件涵盖了娱乐, 社交, 购物, 出行, 金融服务, 身份服务等等领域, 极大地便利了人们的生活\juhao 但与此同时, 各种服务通过应用软件集中于智能手机使得智能手机与个人隐私, 财产安全甚至人身安全的联系变得更加紧密, 从而不可避免地吸引了大量攻击者开发和传播恶意应用来牟取不正当利用\juhao 

目前市场上的智能移动终端设备运行的移动操作系统几乎均为Android和Apple iOS\upcite{mobileOSMarketshare2019}\juhao 其中Android以其免费, 开源的特点吸引了大量智能手机厂商, 占据了超过75\%的市场份额\upcite{mobileOSMarketshare2019}. 最新数据显示, 在2019年Q1国内智能手机销售量中搭载Android的手机销量占比达78.2\%\upcite{mobileOSSalesMarketshare2019}\juhao 然而, Android本身宽松的权限管理以及开放的应用分发方式使其很容易受到攻击, 加上巨大的市场体量, 造成了绝大多数恶意应用把Android作为攻击目标的局面\juhao 虽然近年来Android的权限管理和安全机制不断加强, 同时工信部各大应用分发平台的监管加强, 一定程度上遏制了恶意应用的发展, 但数据显示\upcite{malwareStat}2018年Android新增恶意软件达800.62万个, 感染用户数近1.13亿, 数量仍然庞大\juhao 另外, 恶意软件的类型也持续朝着多样化隐秘化方向发展，新式的恶意软件通过更加难以分析的加壳和混淆技术隐藏自己的恶意行为, 绕过安全软件的查杀\juhao 因此, Android平台的安全问题依然严峻\juhao 

为了阻止恶意应用被下载运行, 保护用户手机的信息安全, 各大应用分发平台需要能够精确有效地判断开发者提交的应用是否为恶意应用, 而捕获应用的行为是分析一个新应用是否为恶意应用的必要前提\juhao 对应用软件的行为获取方法有两个大类: 静态方式和动态方式\juhao 静态方式即在不运行应用软件的情况下对应用软件内部的资源文件、代码、数据等进行分析, 获取应用的特征, 代码逻辑等; 动态方式则是运行应用软件, 在执行过程中对软件的代码执行路径, 数据访问等进行监控和记录\juhao 在目前Android平台的应用加壳和混淆技术成熟的情况下, 单独的静态分析无法获取包含应用的真正逻辑的代码和数据, 因而无法获取到应用行为, 必须通过动态的方式才能捕获到包含应用真实目的的行为, 获取相应的数据, 从而判断应用是否为恶意应用\juhao 另外, 动态分析还能够在运行中捕获到执行应用真正逻辑的代码和数据(脱壳), 从而结合静态分析揭示更加完整的应用行为\juhao 因此, 对Android平台移动应用的动态行为捕获技术进行研究, 有助于识别和分析隐蔽性越来越强的恶意应用, 从而遏制恶意应用的传播, 提升Android平台的安全性\juhao

\section{国内外研究现状和发展方向}
Android系统从发布至今已有10年, 目前国内外已有许多Android应用动态分析相关的研究成果发表\juhao 这些成果借鉴了传统PC平台的动态分析方法, 并结合了Android平台的自身特点, 在本地指令层面, 系统调用层面, 本地函数层面, Java指令层面, Java方法层面中部分或全部层面对应用的运行进行跟踪记录, 并在此基础上结合污点传播技术实现了隐私数据泄露的检测功能, 结合对应用加壳混淆机制的研究实现了脱壳和去混淆功能, 给恶意应用的分析提供了许多强有力的工具\juhao 下文介绍了一些有代表性的成果\juhao

文伟平等构建了一种动态监控系统\upcite{chinese2}\juhao 该系统通过加载linux内核模块劫持文件读取相关的系统调用来监控文件读取，利用Netfilter机制对应用程序的联网动作进行监测，并利用Xposed框架hook应用层的相关API来监控应用的敏感行为例如发送短信，拨打电话等\juhao 该系统可以监控到预定义的敏感行为, 但无法对应用的全面调用进行捕获和分析\juhao 

Enck William等构建了名为Taintdroid\upcite{taintdroid}的隐私数据跟踪系统\juhao 该系统采用了污点传播技术, 通过修改Android系统Java层与隐私数据获取相关的API给隐私数据添加标记, 通过修改Android Runtime的Dalvik虚拟机运行机制实现了带标记隐私数据在虚拟机内部的透明传播, 通过修改Android系统进程间通信的接口实现了带标记隐私数据跨进程传播, 通过修改Java层文件和网络的API实现记录带标记的隐私数据去向, 从而能够检测到应用泄露隐私数据的行为\juhao 不过该系统有以下局限性: 
1. 没有对应用的所有敏感行为进行监控, 例如拨打电话, 发送短信等;
2. 没有对Native层的函数进行监控, 无法检测到应用通过JNI接口调用自身Native模块泄露隐私数据的行为;
3. 针对特定Android版本, 并且不再支持Android4.3以后的版本使用;
 
Desnos Anthony等构建了名为Droidbox的\upcite{droidbox}动态分析系统\juhao 该系统使用了Taintdroid\upcite{taintdroid}来监控隐私数据泄露, 另外通过修改Android系统源代码中敏感API的方式实现对Java层的电话, 短信, 网络, 文件, Java类动态加载, 加密等API调用的监控, 能够记录应用在Java层的敏感行为\juhao 之后为避免频繁修改系统以适应Android版本变化, 该系统更改了监控Java层敏感API调用的方式, 通过反编译需要监控的应用并在敏感API调用前插入监控代码, 再重新打包生成修改后的应用的方式实现监控, 并为将实现新的监控方案的工具命名为APIMonitor\upcite{apimonitor}\juhao 
但该系统只涉及了Java层预定义的敏感API的监控, 没有实现对应用自身的Java方法调用的监控, 并且没有实现对应用本地函数层调用的监控, 因此无法完整的揭示应用的行为; 另外该系统也针对特定Android版本开发, 并且不支持Android4.1之后的系统使用; 对于采用修改应用本身实现监控的APIMonitor, 由于目前加壳和混淆以及应用完整性检查技术的成熟, 已经几乎失效\juhao

Yan Lok Kwong等构建了名为DroidScope\upcite{droidscope}的动态分析系统\juhao 该系统通过修改运行Android系统的qemu虚拟机以及Android系统中的Dalvik虚拟机实现了了对本地指令层面和Java指令层面的监控追踪, 并在此基础上实现了污点传播分析数据泄露, 监控Java和本地次层敏感API调用等功能\juhao 该系统在底层实现了对应用运行的全面监控, 并提供了接口用以在特定事件(例如执行系统调用, 执行本地函数, 读写内存等)发生时添加自定义的处理逻辑, 可以用来开发特定用途(例如脱壳)的工具\juhao 但是该系统也有一些局限性: 
1. 提供了对底层执行的监控功能因而性能开销较大; 
2. 依赖于虚拟机环境, 受模拟器检测技术的影响, 恶意应用会在检测到模拟器运行环境时隐藏自己的恶意行为, 使得分析结果不准确
3. Java部分的监控通过修改Android系统中Dalvik虚拟机来完成, 对特定Android版本有效, 然而目前Android系统已经使用Art虚拟机代替了Dalvik虚拟机, 该系统无法应用于目前的应用分析\juhao

Tam Kimberly等构建了名为CopperDroid\upcite{copperdroid}的动态分析系统\juhao 该系统基于qemu虚拟机, 通过VMI技术捕获应用运行时调用的系统调用序列及相应参数, 然后通过解析记录的系统调用序列和对应参数重建出应用在本地函数层面和Java方法层面的具体行为, 例如发送短信, 拨打电话, 进行网络传输, 进行文件读写, 启动进程, 进程间通信等\juhao 由于只需要系统调用序列, 该系统不需要对Android系统进行修改, 能够较好的兼容Android版本的升级, 但仍由一些局限性:
1. 系统基于虚拟机环境, 受模拟器检测技术的影响;
2. 没有对Java层方法进行具体的监控, 会丢失掉一些Java层的行为;
3. 重构应用行为依赖于特定Java层行为与系统调用的映射关系, 而这个关系可能发生变化而使得结果不准确\juhao

Xue Lei等构建了名为Malton\upcite{malton}的动态分析系统\juhao 该系统运行于真机上, 使用了Valgrind框架来获得指令级别的监控能力, 依靠Valgrind的FunctionWrapper机制来hook系统调用, 系统函数库和重要的Android Runtime(ART)函数\juhao 该系统利用ART会编译所有Java方法的机制, 收集OAT文件中Java方法对应的机器码的入口地址\juhao 通过每条机器执行前比较其地址是否为某个Java方法的地址, 该系统实现在机器执行层面准确的监控Java方法的调用\juhao 此外该系统还包括污点传播分析数据流, 执行路径扫描和分支强制执行等技术, 是一个完整有效的动态分析工具, 并且不受模拟器检测技术的影响\juhao 该系统没有修改Android源代码, 有一定的跨Android版本运行的能力, 但在Android7.1以后Android系统不再在应用安装时编译所有Java方法而是根据应用的运行情况选择性的编译, 这对该系统会造成很大影响; 此外, Valgrind框架的性能开销巨大, 会使得应用运行数十倍的变慢, 因此基于Valgrind框架实现的该系统性能开销很高\juhao



从上面的分析可以看到, Android平台的动态分析在向多层次监控, 完整调用监控, 真机运行等方面发展, 能提供越来越详细有效的应用行为记录\juhao 



\section{论文主要工作}
本文分析了目前已有的一些安卓系统应用行为监测系统的实现方式和优缺点, 并且通过hook技术以及对安卓8.1源代码的修改设计和实现了一个运行于Nexus 5x(Google的一款智能手机)的高性能应用动态行为捕获系统. 该系统能够捕获到Java层的所有方法调用以及Native层的重要函数调用, 并且支持动态地调整需要监控的目标方法(Java层)和函数(Native层). 本文使用常用应用对该系统进行了测试, 结果显示与同样能捕获到所有java层方法调用的Android Device Monitor相比本系统的性能开销明显更低.

\section{论文组织结构}
根据本文研究的特点, 本文的内容按如下方式组织:

第一章为绪论, 主要说明了本文课题的研究背景和研究意义, 简述了国内外对本文课题的研究成果及相关工具和技术, 介绍了本文的主要工作内容和文章组织结构\juhao 

第二章为背景技术介绍, 主要讲述了Android系统的基本架构, Android应用的基本结构, Android平台的常用动态分析技术和应用保护技术, Android Runtime的运行机制, 以及本系统用到的一个hook框架---Frida\juhao

第三章为系统设计和实现, 详细说明了本文提出的应用动态行为捕获系统的设计实现方案\juhao

第四章为实验与结果分析, 描述了对本系统进行测试的实验环境, 实验方法并对实验结果进行了分析和总结\juhao

第五章为总结与展望, 主要是整理本文所做的工作，并简要分析了本文提出系统的局限性和改进方案\juhao

 